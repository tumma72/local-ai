<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>local-ai Server - Welcome</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, Cantarell, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 2rem;
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 2rem;
                text-align: center;
            }

            .header h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
                font-weight: 700;
            }

            .header p {
                font-size: 1.1rem;
                opacity: 0.9;
            }

            .content {
                padding: 2rem;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }

            .server-status {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 1.5rem;
                border: 1px solid #e9ecef;
            }

            .server-status h2 {
                color: #667eea;
                margin-bottom: 1.5rem;
                font-size: 1.5rem;
            }

            .status-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .status-item {
                padding: 0.75rem;
                border-radius: 6px;
                background: white;
            }

            .status-item strong {
                display: block;
                color: #6c757d;
                font-size: 0.85rem;
                margin-bottom: 0.25rem;
            }

            .status-item span {
                font-size: 1rem;
                color: #495057;
            }

            .status-health {
                grid-column: span 2;
                text-align: center;
                padding: 1rem;
            }

            .health-healthy {
                background: #d4edda;
                color: #155724;
            }

            .health-unhealthy {
                background: #f8d7da;
                color: #721c24;
            }

            .health-unknown {
                background: #fff3cd;
                color: #856404;
            }

            .model-tester {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 1.5rem;
                border: 1px solid #e9ecef;
            }

            .model-tester h2 {
                color: #764ba2;
                margin-bottom: 1.5rem;
                font-size: 1.5rem;
            }

            .model-selector {
                margin-bottom: 1rem;
            }

            .model-selector label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 500;
                color: #495057;
            }

            .model-selector select {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #ced4da;
                border-radius: 6px;
                font-size: 1rem;
                background: white;
                cursor: pointer;
            }

            .chat-area {
                height: 300px;
                border: 1px solid #ced4da;
                border-radius: 6px;
                padding: 1rem;
                margin-bottom: 1rem;
                overflow-y: auto;
                background: white;
                font-family:
                    "SFMono-Regular", Consolas, "Liberation Mono", Menlo,
                    monospace;
                font-size: 0.9rem;
                line-height: 1.4;
            }

            .message {
                margin-bottom: 1rem;
                padding: 0.75rem;
                border-radius: 6px;
                max-width: 80%;
            }

            .user-message {
                background: #e9ecef;
                margin-left: auto;
                text-align: right;
            }

            .assistant-message {
                background: #d4edda;
                margin-right: auto;
            }

            .input-area {
                display: flex;
                gap: 0.5rem;
            }

            .input-area input {
                flex: 1;
                padding: 0.75rem;
                border: 1px solid #ced4da;
                border-radius: 6px;
                font-size: 1rem;
            }

            .input-area button {
                padding: 0.75rem 1.5rem;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 1rem;
                cursor: pointer;
                font-weight: 500;
            }

            .input-area button:hover {
                opacity: 0.9;
            }

            .loading {
                color: #6c757d;
                font-style: italic;
                padding: 0.5rem;
            }

            .error {
                color: #dc3545;
                background: #f8d7da;
                padding: 0.75rem;
                border-radius: 6px;
                margin-bottom: 1rem;
            }

            /* Loading spinner */
            .spinner {
                border: 3px solid #f3f3f3;
                border-top: 3px solid #667eea;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                animation: spin 1s linear infinite;
                display: inline-block;
                margin-right: 8px;
                vertical-align: middle;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .loading-container {
                display: flex;
                align-items: center;
                padding: 0.75rem;
                color: #6c757d;
                background: #f8f9fa;
                border-radius: 6px;
                margin-bottom: 1rem;
            }

            /* Error banner */
            .error-banner {
                background: #f8d7da;
                border: 1px solid #f5c6cb;
                border-radius: 6px;
                padding: 1rem;
                margin-bottom: 1rem;
                color: #721c24;
            }

            .error-banner strong {
                display: block;
                margin-bottom: 0.5rem;
            }

            /* Thinking blocks for AI reasoning */
            .thinking-block {
                background: #f5f5f5;
                border-left: 4px solid #999;
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 0 6px 6px 0;
                font-size: 0.85rem;
                color: #666;
            }

            .thinking-block .thinking-header {
                display: block;
                margin-bottom: 0.5rem;
                color: #555;
                font-weight: 500;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            }

            .thinking-content {
                white-space: pre-wrap;
                word-wrap: break-word;
                font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            }

            /* Debug panel - collapsible */
            .debug-toggle {
                cursor: pointer;
                color: #667eea;
                margin-top: 1rem;
                display: inline-block;
                font-size: 0.9rem;
                user-select: none;
            }

            .debug-toggle:hover {
                text-decoration: underline;
            }

            .debug-info {
                margin-top: 0.5rem;
                padding: 1rem;
                background: #e9ecef;
                border-radius: 6px;
                font-size: 0.85rem;
                overflow-x: auto;
            }

            .debug-info.collapsed {
                display: none;
            }

            .debug-info pre {
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .footer {
                text-align: center;
                padding: 1.5rem;
                background: #f8f9fa;
                color: #6c757d;
                font-size: 0.9rem;
                border-top: 1px solid #e9ecef;
            }

            @media (max-width: 768px) {
                .content {
                    grid-template-columns: 1fr;
                }

                .message {
                    max-width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ðŸš€ local-ai Server</h1>
                <p>Offline AI assistance for Apple Silicon</p>
            </div>

            <div class="content">
                <div class="server-status">
                    <h2>ðŸ“Š Server Status</h2>
                    <div class="status-grid">
                        <div class="status-item">
                            <strong>Host</strong>
                            <span id="server-host"
                                >{{ status.host or "N/A" }}</span
                            >
                        </div>
                        <div class="status-item">
                            <strong>Port</strong>
                            <span id="server-port"
                                >{{ status.port or "N/A" }}</span
                            >
                        </div>
                        <div class="status-item">
                            <strong>PID</strong>
                            <span id="server-pid"
                                >{{ status.pid or "N/A" }}</span
                            >
                        </div>
                        <div class="status-item">
                            <strong>Running</strong>
                            <span id="server-running"
                                >{{ "Yes" if status.running else "No" }}</span
                            >
                        </div>
                        <div class="status-item" style="grid-column: span 2">
                            <strong>Available Models</strong>
                            <span id="server-models"
                                >{{ models|length }} models available</span
                            >
                        </div>
                        <div class="status-health">
                            <strong>Health Status</strong>
                            <div
                                id="health-status"
                                class="status-item {% if status.health == 'healthy' %}health-healthy {% elif status.health == 'unhealthy' %}health-unhealthy {% else %}health-unknown {% endif %}"
                            >
                                {{ status.health or "unknown" | upper }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="model-tester">
                    <h2>ðŸ§ª Model Tester</h2>
                    <p style="margin-bottom: 1rem; color: #6c757d">
                        Test available models directly in your browser before
                        integrating with clients.
                    </p>

                    <div class="model-selector">
                        <label for="model-select">Select Model:</label>
                        <select id="model-select">
                            {% if models and models|length > 0 %} {% for model
                            in models %}
                            <option value="{{ model }}">{{ model }}</option>
                            {% endfor %} {% else %}
                            <option value="" disabled selected>
                                Loading models...
                            </option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="chat-area" id="chat-area">
                        <div class="message assistant-message">
                            Welcome to local-ai! Select a model and type a
                            message to test it.
                        </div>
                    </div>

                    <div class="input-area">
                        <input
                            type="text"
                            id="chat-input"
                            placeholder="Type your message here..."
                            disabled="disabled"
                            onkeypress="handleKeyPress(event)"
                        />
                        <button
                            id="send-button"
                            onclick="sendMessage()"
                            disabled="disabled"
                        >
                            Send
                        </button>
                    </div>

                    <div class="debug-toggle" onclick="toggleDebug()">
                        <span id="debug-toggle-text">â–¶ Show Debug Info</span>
                    </div>
                    <div class="debug-info collapsed" id="debug-panel">
                        <strong>Debug Info:</strong>
                        <pre id="debug-info">Server: {{ status.host }}:{{ status.port }}
Models available: {{ models|length }}
Status: {{ status.health or 'unknown' }}</pre>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p>
                    local-ai â€¢ Offline AI for Apple Silicon â€¢
                    <a
                        href="https://github.com/your-repo/local-ai"
                        style="color: #667eea"
                        >GitHub</a
                    >
                </p>
            </div>
        </div>

        <script>
            // Enable input when model is selected
            const modelSelect = document.getElementById("model-select");
            const chatInput = document.getElementById("chat-input");
            const sendButton = document.getElementById("send-button");
            const chatArea = document.getElementById("chat-area");
            const debugInfo = document.getElementById("debug-info");

            modelSelect.addEventListener("change", function () {
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            });

            function handleKeyPress(event) {
                if (event.key === "Enter") {
                    sendMessage();
                }
            }

            // Toggle debug panel visibility
            function toggleDebug() {
                const panel = document.getElementById('debug-panel');
                const toggleText = document.getElementById('debug-toggle-text');

                if (panel.classList.contains('collapsed')) {
                    panel.classList.remove('collapsed');
                    toggleText.textContent = 'â–¼ Hide Debug Info';
                } else {
                    panel.classList.add('collapsed');
                    toggleText.textContent = 'â–¶ Show Debug Info';
                }
            }

            /**
             * Parse AI response to extract thinking tags and regular content.
             * Detects both <think> and <thinking> tags.
             */
            function parseThinkingTags(response) {
                const thinkingBlocks = [];
                let cleanedResponse = response;

                // Match both <think> and <thinking> tags (case insensitive, multiline)
                const thinkingRegex = /<think(?:ing)?>([\s\S]*?)<\/think(?:ing)?>/gi;

                // Use matchAll to extract all thinking blocks
                const matches = Array.from(response.matchAll(thinkingRegex));
                for (const match of matches) {
                    thinkingBlocks.push(match[1].trim());
                }

                // Remove thinking tags from response
                cleanedResponse = cleanedResponse.replace(thinkingRegex, '').trim();

                return {
                    thinking: thinkingBlocks,
                    response: cleanedResponse
                };
            }

            /**
             * Create a thinking block element using safe DOM methods
             */
            function createThinkingBlock(content, id) {
                const thinkingDiv = document.createElement("div");
                thinkingDiv.id = id;
                thinkingDiv.className = "thinking-block";

                const header = document.createElement("span");
                header.className = "thinking-header";
                header.textContent = "ðŸ’­ Reasoning:";

                const contentDiv = document.createElement("div");
                contentDiv.className = "thinking-content";
                contentDiv.textContent = content;

                thinkingDiv.appendChild(header);
                thinkingDiv.appendChild(contentDiv);

                return thinkingDiv;
            }

            /**
             * Create a loading indicator with spinner using safe DOM methods
             */
            function createLoadingIndicator() {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-indicator';
                loadingDiv.className = 'loading-container';

                const spinner = document.createElement('div');
                spinner.className = 'spinner';

                const text = document.createElement('span');
                text.textContent = 'Loading available models...';

                loadingDiv.appendChild(spinner);
                loadingDiv.appendChild(text);

                return loadingDiv;
            }

            /**
             * Create an error banner using safe DOM methods
             */
            function createErrorBanner(errorMessage) {
                const errorBanner = document.createElement('div');
                errorBanner.className = 'error-banner';

                const title = document.createElement('strong');
                title.textContent = 'âš  Failed to Load Models';

                const message = document.createElement('p');
                message.textContent = errorMessage;

                const hint = document.createElement('p');
                hint.style.marginTop = '0.5rem';
                hint.style.fontSize = '0.9rem';
                hint.textContent = 'Check the debug panel below for details, or ensure the server is running.';

                errorBanner.appendChild(title);
                errorBanner.appendChild(message);
                errorBanner.appendChild(hint);

                return errorBanner;
            }

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                const selectedModel = modelSelect.value;

                // Add user message to chat (not AI response)
                addMessageToChat(message, "user-message", false);
                chatInput.value = "";
                chatInput.disabled = true;
                sendButton.disabled = true;

                // Show loading indicator
                const loadingId = addMessageToChat("Thinking...", "loading", false);

                try {
                    const response = await fetch("/api/chat", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: selectedModel,
                            messages: [{ role: "user", content: message }],
                            stream: false,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();

                    // Remove loading indicator
                    removeMessage(loadingId);

                    // Add assistant response (IS an AI response - parse thinking tags)
                    const assistantMessage = data.choices[0].message.content;
                    addMessageToChat(assistantMessage, "assistant-message", true);

                    // Update debug info
                    debugInfo.textContent += `\n\nTest completed:
Model: ${selectedModel}
Prompt tokens: ${data.usage.prompt_tokens}
Completion tokens: ${data.usage.completion_tokens}
Total tokens: ${data.usage.total_tokens}`;
                } catch (error) {
                    // Remove loading indicator
                    removeMessage(loadingId);

                    // Show error
                    addMessageToChat(`Error: ${error.message}`, "error", false);
                    debugInfo.textContent += `\n\nError: ${error.message}`;
                    console.error("Error:", error);
                } finally {
                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    chatInput.focus();
                }
            }

            /**
             * Add a message to the chat area.
             * For AI responses, parses and displays thinking tags separately.
             */
            function addMessageToChat(message, className, isAIResponse = false) {
                const messageId = "msg-" + Date.now();

                if (isAIResponse) {
                    // Parse thinking tags from AI response
                    const parsed = parseThinkingTags(message);

                    // Add thinking blocks first (if any)
                    parsed.thinking.forEach((thinkingContent, index) => {
                        const thinkingDiv = createThinkingBlock(
                            thinkingContent,
                            `thinking-${messageId}-${index}`
                        );
                        chatArea.appendChild(thinkingDiv);
                    });

                    // Add regular response (if there's content after removing thinking tags)
                    if (parsed.response) {
                        const messageDiv = document.createElement("div");
                        messageDiv.id = messageId;
                        messageDiv.className = `message ${className}`;
                        messageDiv.textContent = parsed.response;
                        chatArea.appendChild(messageDiv);
                    }
                } else {
                    // Regular message (user or system)
                    const messageDiv = document.createElement("div");
                    messageDiv.id = messageId;
                    messageDiv.className = `message ${className}`;
                    messageDiv.textContent = message;
                    chatArea.appendChild(messageDiv);
                }

                chatArea.scrollTop = chatArea.scrollHeight;
                return messageId;
            }

            function removeMessage(messageId) {
                const message = document.getElementById(messageId);
                if (message) {
                    message.remove();
                }
            }

            // Auto-scroll chat area
            function scrollChatToBottom() {
                chatArea.scrollTop = chatArea.scrollHeight;
            }

            // Fetch models dynamically from the server
            async function fetchModels() {
                // Remove the loading message
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }

                try {
                    const response = await fetch('/v1/models');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const models = data.data.map(m => m.id);

                    if (models && models.length > 0) {
                        // Clear existing options using safe DOM method
                        while (modelSelect.firstChild) {
                            modelSelect.removeChild(modelSelect.firstChild);
                        }

                        // Add new options
                        models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            modelSelect.appendChild(option);
                        });

                        // Update model count
                        document.getElementById('server-models').textContent =
                            `${models.length} models available`;

                        // Enable chat input
                        chatInput.disabled = false;
                        sendButton.disabled = false;

                        // Show success message
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'message assistant-message';
                        infoDiv.textContent = `âœ“ Found ${models.length} models. Select a model to start chatting.`;
                        chatArea.appendChild(infoDiv);
                        chatArea.scrollTop = chatArea.scrollHeight;
                    } else {
                        throw new Error('No models found');
                    }
                } catch (error) {
                    console.error('Failed to fetch models:', error);

                    // Show prominent error banner using safe DOM method
                    const errorBanner = createErrorBanner(error.message);
                    chatArea.appendChild(errorBanner);
                    chatArea.scrollTop = chatArea.scrollHeight;

                    // Log to debug panel
                    debugInfo.textContent += `\n\nError loading models: ${error.message}`;
                }
            }

            // Initial scroll
            scrollChatToBottom();

            // Fetch models when page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Add loading indicator with spinner using safe DOM method
                const loadingDiv = createLoadingIndicator();
                chatArea.appendChild(loadingDiv);
                chatArea.scrollTop = chatArea.scrollHeight;

                // Fetch models after brief delay
                setTimeout(fetchModels, 500);
            });
        </script>
    </body>
</html>
